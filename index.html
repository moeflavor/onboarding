<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MoeFlavor Training Portal</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Courier New', monospace;
      background: #1a1a2e;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    #gameContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    #header {
      text-align: center;
      margin-bottom: 10px;
    }

    #header h1 {
      font-size: 2.5em;
      color: #F5008B;
      text-shadow: 0 0 10px rgba(245, 0, 139, 0.5);
      margin-bottom: 10px;
    }

    #header p {
      color: #aaa;
      font-size: 0.9em;
    }

    #statsBar {
      background: #0f0f1e;
      border: 3px solid #F5008B;
      border-radius: 8px;
      padding: 15px 30px;
      display: flex;
      gap: 40px;
      align-items: center;
      box-shadow: 0 0 20px rgba(245, 0, 139, 0.3);
    }

    .statGroup {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .statLabel {
      font-size: 0.8em;
      color: #aaa;
      text-transform: uppercase;
    }

    .statBar {
      width: 200px;
      height: 20px;
      background: #333;
      border: 2px solid #555;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .statFill {
      height: 100%;
      transition: width 0.3s ease;
      position: relative;
    }

    .hpBar {
      background: linear-gradient(90deg, #F5008B, #F77AAC);
    }

    .xpBar {
      background: linear-gradient(90deg, #21ef80, #4CAF50);
    }

    .statText {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 0.75em;
      font-weight: bold;
      text-shadow: 0 0 3px #000;
      z-index: 1;
    }

    #canvasContainer {
      position: relative;
      border: 4px solid #F5008B;
      border-radius: 8px;
      box-shadow: 0 0 30px rgba(245, 0, 139, 0.4);
      background: #000;
    }

    #gameCanvas {
      display: block;
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
    }

    #loadingScreen {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      z-index: 1000;
    }

    #loadingScreen.hidden {
      display: none;
    }

    .spinner {
      border: 4px solid #333;
      border-top: 4px solid #F5008B;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modalContent {
      background: #0f0f1e;
      border: 3px solid #F5008B;
      border-radius: 12px;
      padding: 30px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 0 40px rgba(245, 0, 139, 0.5);
    }

    .modalContent h2 {
      color: #F5008B;
      margin-bottom: 20px;
      font-size: 1.8em;
    }

    .modalContent p {
      line-height: 1.6;
      margin-bottom: 15px;
      color: #ccc;
    }

    .lessonList {
      margin: 20px 0;
    }

    .lessonItem {
      background: #1a1a2e;
      border: 2px solid #333;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .lessonItem:hover {
      border-color: #F5008B;
      background: #252538;
    }

    .lessonItem.completed {
      border-color: #21ef80;
      opacity: 0.7;
    }

    .lessonItem.locked {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btnGroup {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }

    .btn {
      background: linear-gradient(45deg, #F5008B, #F77AAC);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      font-size: 1em;
      transition: all 0.3s;
      box-shadow: 0 4px 0 #000, 0 0 15px rgba(245, 0, 139, 0.5);
    }

    .btn:hover {
      transform: translateY(2px);
      box-shadow: 0 2px 0 #000, 0 0 25px rgba(245, 0, 139, 0.8);
    }

    .btn:active {
      transform: translateY(4px);
      box-shadow: 0 0 0 #000;
    }

    .btn.secondary {
      background: linear-gradient(45deg, #333, #555);
    }

    .quizQuestion {
      background: #1a1a2e;
      border: 2px solid #F5008B;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .quizOptions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 15px;
    }

    .quizOption {
      background: #252538;
      border: 2px solid #333;
      border-radius: 6px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .quizOption:hover {
      border-color: #F5008B;
      background: #2a2a40;
    }

    .quizOption.selected {
      border-color: #F5008B;
      background: #2a2a40;
    }

    .quizOption.correct {
      border-color: #21ef80;
      background: rgba(33, 239, 128, 0.2);
    }

    .quizOption.incorrect {
      border-color: #ff4444;
      background: rgba(255, 68, 68, 0.2);
    }

    #instructions {
      background: #0f0f1e;
      border: 2px solid #333;
      border-radius: 8px;
      padding: 15px;
      margin-top: 10px;
      text-align: center;
      max-width: 800px;
    }

    #instructions p {
      color: #aaa;
      font-size: 0.9em;
    }

    .locationMarker {
      position: absolute;
      cursor: pointer;
      transition: transform 0.2s;
      z-index: 100;
    }

    .locationMarker:hover {
      transform: scale(1.2);
    }

    .locationMarker.locked {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .locationIcon {
      font-size: 32px;
      filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.8));
    }

    .locationLabel {
      position: absolute;
      bottom: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      white-space: nowrap;
      background: rgba(0, 0, 0, 0.8);
      padding: 2px 6px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <div id="header">
      <h1>ðŸŒ¸ MoeFlavor Training Portal ðŸŒ¸</h1>
      <p>Navigate your pixel adventure and complete quests to level up!</p>
    </div>

    <div id="statsBar">
      <div class="statGroup">
        <div class="statLabel">Health Points</div>
        <div class="statBar">
          <div class="statFill hpBar" id="hpFill" style="width: 100%">
            <div class="statText" id="hpText">100 / 100</div>
          </div>
        </div>
      </div>
      <div class="statGroup">
        <div class="statLabel">Experience</div>
        <div class="statBar">
          <div class="statFill xpBar" id="xpFill" style="width: 0%">
            <div class="statText" id="xpText">0 / 600</div>
          </div>
        </div>
      </div>
      <div class="statGroup">
        <div class="statLabel">Level</div>
        <div style="font-size: 1.5em; color: #21ef80; text-align: center;" id="levelText">1</div>
      </div>
    </div>

    <div id="canvasContainer">
      <canvas id="gameCanvas" width="800" height="600"></canvas>
      <div id="loadingScreen">
        <div class="spinner"></div>
        <p>Loading Training Portal...</p>
      </div>
    </div>

    <div id="instructions">
      <p>ðŸŽ® Use <strong>WASD</strong> or <strong>Arrow Keys</strong> to move â€¢ Click on quest locations to start training</p>
    </div>
  </div>

  <!-- Modal for Quest Locations -->
  <div id="questModal" class="modal">
    <div class="modalContent">
      <h2 id="modalTitle">Quest Location</h2>
      <p id="modalDescription"></p>
      <div id="modalBody"></div>
      <div class="btnGroup">
        <button class="btn secondary" onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzz_zl42rXJXpwoEE-M5RyRw5lQoIDfWahRV1zbuSv8xL-ZdGyqxV4EGc0lG4nRcr9z/exec';
    const TILE_SIZE = 32;
    const MAP_WIDTH = 25;
    const MAP_HEIGHT = 19;

    // Game State
    let gameState = {
      player: {
        x: 400,
        y: 300,
        speed: 3,
        direction: 'down',
        isWalking: false
      },
      stats: {
        hp: 100,
        maxHp: 100,
        xp: 0,
        maxXp: 600,
        level: 1
      },
      progress: {
        completedLocations: [],
        completedLessons: {}
      },
      questLocations: [
        { id: 'castle', name: 'ðŸ° Castle', x: 400, y: 150, icon: 'ðŸ°', unlocked: true },
        { id: 'toolshop', name: 'ðŸ”§ Tool Shop', x: 200, y: 250, icon: 'ðŸ”§', unlocked: false },
        { id: 'forge', name: 'âš’ï¸ Forge', x: 600, y: 250, icon: 'âš’ï¸', unlocked: false },
        { id: 'workshop', name: 'ðŸ› ï¸ Workshop', x: 300, y: 400, icon: 'ðŸ› ï¸', unlocked: false },
        { id: 'market', name: 'ðŸª Market', x: 500, y: 400, icon: 'ðŸª', unlocked: false },
        { id: 'service', name: 'ðŸ›ï¸ Service Hall', x: 400, y: 500, icon: 'ðŸ›ï¸', unlocked: false }
      ],
      trainingData: null
    };

    // Keyboard state
    const keys = {};

    // Canvas setup
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;

    // Load background image
    const mapBackground = new Image();
    mapBackground.src = 'map-background.png';
    let mapLoaded = false;
    mapBackground.onload = () => {
      mapLoaded = true;
      console.log('Map background loaded!');
    };

    // Load saved progress
    function loadProgress() {
      const saved = localStorage.getItem('moeflavor_training_progress');
      if (saved) {
        const data = JSON.parse(saved);
        gameState.stats = data.stats || gameState.stats;
        gameState.progress = data.progress || gameState.progress;

        // Unlock locations based on progress
        gameState.progress.completedLocations.forEach((locId, index) => {
          const nextIndex = index + 1;
          if (nextIndex < gameState.questLocations.length) {
            gameState.questLocations[nextIndex].unlocked = true;
          }
        });
      }
      updateStatsDisplay();
    }

    // Save progress
    function saveProgress() {
      const data = {
        stats: gameState.stats,
        progress: gameState.progress
      };
      localStorage.setItem('moeflavor_training_progress', JSON.stringify(data));
    }

    // Fetch training data from Google Sheets
    async function fetchTrainingData() {
      try {
        const response = await fetch(SCRIPT_URL);
        const data = await response.json();
        gameState.trainingData = data;
        console.log('Training data loaded:', data);
      } catch (error) {
        console.error('Failed to load training data:', error);
        // Use fallback data if API fails
        gameState.trainingData = {
          phases: [
            {
              name: 'Onboarding',
              modules: [
                {
                  name: 'Welcome to MoeFlavor',
                  lessons: [
                    { title: 'Introduction', content: 'Welcome to the MoeFlavor family!' }
                  ],
                  quiz: [
                    {
                      question: 'What is MoeFlavor?',
                      options: ['A kawaii brand', 'A restaurant', 'A game', 'A book'],
                      correct: 0
                    }
                  ]
                }
              ]
            }
          ]
        };
      }
    }

    // Update stats display
    function updateStatsDisplay() {
      const hpPercent = (gameState.stats.hp / gameState.stats.maxHp) * 100;
      const xpPercent = (gameState.stats.xp / gameState.stats.maxXp) * 100;

      document.getElementById('hpFill').style.width = `${hpPercent}%`;
      document.getElementById('hpText').textContent = `${gameState.stats.hp} / ${gameState.stats.maxHp}`;

      document.getElementById('xpFill').style.width = `${xpPercent}%`;
      document.getElementById('xpText').textContent = `${gameState.stats.xp} / ${gameState.stats.maxXp}`;

      document.getElementById('levelText').textContent = gameState.stats.level;
    }

    // Add XP
    function addXP(amount) {
      gameState.stats.xp += amount;
      if (gameState.stats.xp >= gameState.stats.maxXp) {
        gameState.stats.level++;
        gameState.stats.xp = 0;
        gameState.stats.maxXp = Math.floor(gameState.stats.maxXp * 1.5);
        gameState.stats.hp = gameState.stats.maxHp;
      }
      updateStatsDisplay();
      saveProgress();
    }

    // Draw pixel map
    function drawMap() {
      if (mapLoaded) {
        // Draw the background image
        ctx.drawImage(mapBackground, 0, 0, canvas.width, canvas.height);
      } else {
        // Fallback while loading
        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, '#4CC9E5');
        gradient.addColorStop(0.7, '#7DD9F0');
        gradient.addColorStop(1, '#4CAF50');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
    }

    // Draw player character
    function drawPlayer() {
      const px = gameState.player.x;
      const py = gameState.player.y;

      // Shadow
      ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
      ctx.beginPath();
      ctx.ellipse(px, py + 20, 8, 4, 0, 0, Math.PI * 2);
      ctx.fill();

      // Head
      ctx.fillStyle = '#FFD1B3';
      ctx.fillRect(px - 8, py - 16, 16, 16);
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 2;
      ctx.strokeRect(px - 8, py - 16, 16, 16);

      // Eyes
      ctx.fillStyle = '#000';
      if (gameState.player.direction === 'left') {
        ctx.fillRect(px - 6, py - 10, 3, 3);
      } else if (gameState.player.direction === 'right') {
        ctx.fillRect(px + 3, py - 10, 3, 3);
      } else {
        ctx.fillRect(px - 6, py - 10, 3, 3);
        ctx.fillRect(px + 3, py - 10, 3, 3);
      }

      // Body
      ctx.fillStyle = '#F5008B';
      ctx.fillRect(px - 8, py, 16, 12);
      ctx.strokeRect(px - 8, py, 16, 12);

      // Legs
      const legOffset = gameState.player.isWalking ? 1 : 0;
      ctx.fillStyle = '#333';
      ctx.fillRect(px - 7, py + 12, 6, 10);
      ctx.strokeRect(px - 7, py + 12, 6, 10);
      ctx.fillRect(px + 1, py + 12, 6, 10);
      ctx.strokeRect(px + 1, py + 12, 6, 10);
    }

    // Draw quest location markers
    function drawQuestLocations() {
      gameState.questLocations.forEach(location => {
        ctx.save();

        if (!location.unlocked) {
          ctx.globalAlpha = 0.4;
        }

        // Draw icon background
        ctx.fillStyle = location.unlocked ? '#F5008B' : '#666';
        ctx.beginPath();
        ctx.arc(location.x, location.y, 25, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 3;
        ctx.stroke();

        // Draw icon
        ctx.font = 'bold 32px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = '#fff';
        ctx.fillText(location.icon, location.x, location.y);

        // Draw label
        ctx.font = 'bold 12px Courier New';
        ctx.fillStyle = '#000';
        ctx.fillRect(location.x - 40, location.y + 35, 80, 18);
        ctx.fillStyle = '#fff';
        ctx.fillText(location.name, location.x, location.y + 44);

        ctx.restore();
      });
    }

    // Update player movement
    function updatePlayer() {
      let moved = false;
      let newX = gameState.player.x;
      let newY = gameState.player.y;

      if (keys['ArrowUp'] || keys['w']) {
        newY -= gameState.player.speed;
        gameState.player.direction = 'up';
        moved = true;
      }
      if (keys['ArrowDown'] || keys['s']) {
        newY += gameState.player.speed;
        gameState.player.direction = 'down';
        moved = true;
      }
      if (keys['ArrowLeft'] || keys['a']) {
        newX -= gameState.player.speed;
        gameState.player.direction = 'left';
        moved = true;
      }
      if (keys['ArrowRight'] || keys['d']) {
        newX += gameState.player.speed;
        gameState.player.direction = 'right';
        moved = true;
      }

      // Boundary checks
      if (newX >= 20 && newX <= canvas.width - 20) {
        gameState.player.x = newX;
      }
      if (newY >= 20 && newY <= canvas.height - 20) {
        gameState.player.y = newY;
      }

      gameState.player.isWalking = moved;
    }

    // Game loop
    function gameLoop() {
      updatePlayer();

      // Clear and redraw
      drawMap();
      drawQuestLocations();
      drawPlayer();

      requestAnimationFrame(gameLoop);
    }

    // Handle keyboard input
    window.addEventListener('keydown', (e) => {
      if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'w', 'a', 's', 'd'].includes(e.key)) {
        e.preventDefault();
        keys[e.key] = true;
      }
    });

    window.addEventListener('keyup', (e) => {
      keys[e.key] = false;
    });

    // Handle canvas clicks for quest locations
    canvas.addEventListener('click', (e) => {
      const rect = canvas.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const clickY = e.clientY - rect.top;

      gameState.questLocations.forEach(location => {
        const dist = Math.sqrt(
          Math.pow(clickX - location.x, 2) +
          Math.pow(clickY - location.y, 2)
        );

        if (dist < 30) {
          if (location.unlocked) {
            openQuestModal(location);
          } else {
            alert('ðŸ”’ This location is locked! Complete previous quests to unlock.');
          }
        }
      });
    });

    // Open quest modal
    function openQuestModal(location) {
      const modal = document.getElementById('questModal');
      const title = document.getElementById('modalTitle');
      const description = document.getElementById('modalDescription');
      const body = document.getElementById('modalBody');

      title.textContent = location.name;
      description.textContent = `Welcome to the ${location.name}! Complete the training modules to gain experience.`;

      // Generate lesson content
      if (gameState.trainingData && gameState.trainingData.phases) {
        const phase = gameState.trainingData.phases[0];
        if (phase && phase.modules && phase.modules.length > 0) {
          const module = phase.modules[0];

          let html = '<div class="lessonList">';
          if (module.lessons) {
            module.lessons.forEach((lesson, index) => {
              const lessonKey = `${location.id}_${index}`;
              const completed = gameState.progress.completedLessons[lessonKey] || false;
              const statusClass = completed ? 'completed' : '';

              html += `
                <div class="lessonItem ${statusClass}" onclick="viewLesson('${lessonKey}', ${index})">
                  <strong>${completed ? 'âœ…' : 'ðŸ“–'} ${lesson.title || 'Lesson ' + (index + 1)}</strong>
                  <p style="font-size: 0.9em; margin-top: 5px; color: #aaa;">
                    ${completed ? 'Completed!' : 'Click to start'}
                  </p>
                </div>
              `;
            });
          }
          html += '</div>';
          body.innerHTML = html;
        } else {
          body.innerHTML = '<p>No training modules available yet.</p>';
        }
      } else {
        body.innerHTML = '<p>Loading training data...</p>';
      }

      modal.classList.add('active');
    }

    // View lesson
    window.viewLesson = function(lessonKey, lessonIndex) {
      if (!gameState.trainingData?.phases?.[0]?.modules?.[0]?.lessons?.[lessonIndex]) {
        alert('Lesson content not available');
        return;
      }

      const lesson = gameState.trainingData.phases[0].modules[0].lessons[lessonIndex];
      const body = document.getElementById('modalBody');

      body.innerHTML = `
        <div style="background: #1a1a2e; padding: 20px; border-radius: 8px; border: 2px solid #F5008B;">
          <h3 style="color: #F5008B; margin-bottom: 15px;">${lesson.title}</h3>
          <p style="line-height: 1.8; color: #ccc;">${lesson.content || 'Lesson content coming soon...'}</p>
          <div class="btnGroup" style="margin-top: 20px;">
            <button class="btn" onclick="completeLesson('${lessonKey}')">Mark as Complete (+100 XP)</button>
            <button class="btn secondary" onclick="openQuestModal(gameState.questLocations.find(l => l.id === '${lessonKey.split('_')[0]}'))">Back to Lessons</button>
          </div>
        </div>
      `;
    };

    // Complete lesson
    window.completeLesson = function(lessonKey) {
      if (!gameState.progress.completedLessons[lessonKey]) {
        gameState.progress.completedLessons[lessonKey] = true;
        addXP(100);

        // Check if location is complete
        const locationId = lessonKey.split('_')[0];
        const location = gameState.questLocations.find(l => l.id === locationId);

        if (location && !gameState.progress.completedLocations.includes(locationId)) {
          // Check if all lessons for this location are complete
          const locationLessons = Object.keys(gameState.progress.completedLessons)
            .filter(key => key.startsWith(locationId + '_'));

          if (locationLessons.length >= 1) { // Simplified: complete location after 1 lesson
            gameState.progress.completedLocations.push(locationId);

            // Unlock next location
            const currentIndex = gameState.questLocations.findIndex(l => l.id === locationId);
            if (currentIndex >= 0 && currentIndex < gameState.questLocations.length - 1) {
              gameState.questLocations[currentIndex + 1].unlocked = true;
            }

            alert(`ðŸŽ‰ ${location.name} Complete! Next location unlocked!`);
          }
        }

        saveProgress();
        openQuestModal(location);
      }
    };

    // Close modal
    window.closeModal = function() {
      document.getElementById('questModal').classList.remove('active');
    };

    // Initialize game
    async function init() {
      loadProgress();
      await fetchTrainingData();
      document.getElementById('loadingScreen').classList.add('hidden');
      gameLoop();
    }

    // Start game when page loads
    window.addEventListener('load', init);
  </script>
</body>
</html>
