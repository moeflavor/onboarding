<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MoeFlavor Training Portal</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: sans-serif;
      background: #000;
      color: #fff;
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"><circle cx="12" cy="12" r="10" fill="%23F5008B" stroke="white" stroke-width="2"/></svg>') 12 12, auto;
    }

    #gameContainer {
      position: relative;
      width: 100%;
      height: 100%;
    }

    /* Minimal Corner HUD */
    #cornerHUD {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .hudItem {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(0, 0, 0, 0.6);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: bold;
      backdrop-filter: blur(4px);
    }

    .hudIcon {
      font-size: 1.2em;
    }

    .hudValue {
      color: #fff;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
    }

    .hpValue { color: #F5008B; }
    .xpValue { color: #21ef80; }
    .levelValue { color: #FFD700; }

    /* Full-screen map */
    #mapContainer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('map-background.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      image-rendering: pixelated;
    }

    /* Floating clouds */
    .cloud {
      position: absolute;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 100px;
      opacity: 0.4;
      animation: float linear infinite;
      pointer-events: none;
    }

    .cloud::before,
    .cloud::after {
      content: '';
      position: absolute;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 100px;
    }

    .cloud1 {
      width: 100px;
      height: 40px;
      top: 20%;
      left: -100px;
      animation-duration: 45s;
    }

    .cloud1::before {
      width: 50px;
      height: 50px;
      top: -25px;
      left: 10px;
    }

    .cloud1::after {
      width: 60px;
      height: 40px;
      top: -15px;
      right: 10px;
    }

    .cloud2 {
      width: 120px;
      height: 50px;
      top: 40%;
      left: -120px;
      animation-duration: 60s;
      animation-delay: 5s;
    }

    .cloud2::before {
      width: 60px;
      height: 60px;
      top: -30px;
      left: 15px;
    }

    .cloud2::after {
      width: 70px;
      height: 50px;
      top: -20px;
      right: 15px;
    }

    .cloud3 {
      width: 80px;
      height: 35px;
      top: 60%;
      left: -80px;
      animation-duration: 50s;
      animation-delay: 10s;
    }

    .cloud3::before {
      width: 40px;
      height: 40px;
      top: -20px;
      left: 10px;
    }

    .cloud3::after {
      width: 50px;
      height: 35px;
      top: -15px;
      right: 10px;
    }

    @keyframes float {
      from {
        transform: translateX(0);
      }
      to {
        transform: translateX(calc(100vw + 200px));
      }
    }

    /* Quest markers - clean and minimal */
    .quest-marker {
      position: absolute;
      width: 60px;
      height: 60px;
      cursor: pointer;
      transition: transform 0.3s, filter 0.3s;
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .quest-marker::before {
      content: '';
      position: absolute;
      width: 60px;
      height: 60px;
      background: #F5008B;
      border: 3px solid #000;
      border-radius: 50%;
      z-index: -1;
      transition: transform 0.3s;
    }

    .quest-marker:hover::before {
      transform: scale(1.2);
    }

    .quest-marker:hover {
      transform: scale(1.3) translateY(-5px);
      filter: drop-shadow(0 8px 16px rgba(245, 0, 139, 0.6));
    }

    .quest-marker.locked::before {
      background: #666;
    }

    .quest-marker.locked {
      cursor: not-allowed;
    }

    .quest-marker.locked:hover {
      transform: scale(1.1);
    }

    .quest-marker.locked:hover::before {
      transform: scale(1.1);
    }

    .quest-marker-icon {
      font-size: 38px;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
      animation: bounce 2s ease-in-out infinite;
      transition: font-size 0.3s;
      z-index: 1;
    }

    .quest-marker:hover .quest-marker-icon {
      font-size: 42px;
      animation: none;
    }

    /* Tooltip only on hover */
    .quest-marker-label {
      position: absolute;
      bottom: -35px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: bold;
      white-space: nowrap;
      pointer-events: none;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.5);
      opacity: 0;
      transition: opacity 0.3s, bottom 0.3s;
      border: 1px solid rgba(245, 0, 139, 0.5);
    }

    .quest-marker:hover .quest-marker-label {
      opacity: 1;
      bottom: -40px;
    }

    @keyframes bounce {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-8px);
      }
    }

    /* Loading screen */
    #loadingScreen {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      z-index: 1000;
      transition: opacity 0.5s;
    }

    #loadingScreen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .spinner {
      border: 4px solid #333;
      border-top: 4px solid #F5008B;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Modal styling */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
    }

    .modal.active {
      display: flex;
    }

    .modalContent {
      background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1e 100%);
      border: 3px solid #F5008B;
      border-radius: 16px;
      padding: 35px;
      width: 90%;
      max-width: 1000px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 0 60px rgba(245, 0, 139, 0.6);
      animation: modalAppear 0.3s ease-out;
    }

    @keyframes modalAppear {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modalContent h2 {
      color: #F5008B;
      margin-bottom: 20px;
      font-size: 2em;
      text-shadow: 0 0 10px rgba(245, 0, 139, 0.5);
    }

    .modalContent p {
      line-height: 1.8;
      margin-bottom: 15px;
      color: #fff;
    }

    .lessonList {
      margin: 20px 0;
    }

    .lessonItem {
      background: #1a1a2e;
      border: 2px solid #333;
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .lessonItem:hover {
      border-color: #F5008B;
      background: #252538;
      transform: translateX(5px);
    }

    .lessonItem.completed {
      border-color: #21ef80;
      opacity: 0.7;
    }

    .lessonItem.locked {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btnGroup {
      display: flex;
      gap: 15px;
      margin-top: 25px;
    }

    .btn {
      background: linear-gradient(45deg, #F5008B, #F77AAC);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 10px;
      cursor: pointer;
      font-family: sans-serif;
      font-weight: bold;
      font-size: 1em;
      transition: all 0.3s;
      box-shadow: 0 4px 0 #000, 0 0 20px rgba(245, 0, 139, 0.5);
    }

    .btn:hover {
      transform: translateY(2px);
      box-shadow: 0 2px 0 #000, 0 0 30px rgba(245, 0, 139, 0.8);
    }

    .btn:active {
      transform: translateY(4px);
      box-shadow: 0 0 0 #000;
    }

    .btn.secondary {
      background: linear-gradient(45deg, #333, #555);
    }

    /* Scrollbar styling for modal */
    .modalContent::-webkit-scrollbar {
      width: 8px;
    }

    .modalContent::-webkit-scrollbar-track {
      background: #0f0f1e;
      border-radius: 10px;
    }

    .modalContent::-webkit-scrollbar-thumb {
      background: #F5008B;
      border-radius: 10px;
    }

    .modalContent::-webkit-scrollbar-thumb:hover {
      background: #F77AAC;
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <!-- Minimal Corner HUD -->
    <div id="cornerHUD">
      <div class="hudItem">
        <span class="hudIcon">üíñ</span>
        <span class="hudValue hpValue" id="hpText">100</span>
      </div>
      <div class="hudItem">
        <span class="hudIcon">‚ö°</span>
        <span class="hudValue xpValue" id="xpText">0/600</span>
      </div>
      <div class="hudItem">
        <span class="hudIcon">‚≠ê</span>
        <span class="hudValue levelValue" id="levelText">1</span>
      </div>
    </div>

    <!-- Full-screen map -->
    <div id="mapContainer">
      <!-- Floating clouds -->
      <div class="cloud cloud1"></div>
      <div class="cloud cloud2"></div>
      <div class="cloud cloud3"></div>

      <!-- Quest location markers -->
      <div id="questMarkers"></div>

      <div id="loadingScreen">
        <div class="spinner"></div>
        <p>Loading...</p>
      </div>
    </div>
  </div>

  <!-- Modal for Quest Locations -->
  <div id="questModal" class="modal">
    <div class="modalContent">
      <h2 id="modalTitle">Quest Location</h2>
      <p id="modalDescription"></p>
      <div id="modalBody"></div>
      <div class="btnGroup">
        <button class="btn secondary" onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwJOTfofzgR9D4yGQQghS_a2Hc_L9ISdw0TcKO_-9E0_n3FvBgLHC0i6L8rcGrGCe5k/exec';

    // Game State
    let gameState = {
      stats: {
        hp: 100,
        maxHp: 100,
        xp: 0,
        maxXp: 600,
        level: 1
      },
      progress: {
        completedLocations: [],
        completedLessons: {}
      },
      questLocations: [
        { id: 'Castle', name: 'Castle', x: 20, y: 40, icon: 'üè∞', unlocked: true },
        { id: 'Forge', name: 'Forge', x: 85, y: 33, icon: '‚öíÔ∏è', unlocked: true },
        { id: 'ServiceHall', name: 'Service Hall', x: 75, y: 51, icon: 'üç∫', unlocked: true },
        { id: 'Workshop', name: 'Workshop', x: 55, y: 65, icon: 'üßôüèº‚Äç‚ôÇÔ∏è', unlocked: true },
        { id: 'Market', name: 'Market', x: 78, y: 73, icon: 'üß∫', unlocked: true }
      ],
      trainingData: null
    };

    // Load saved progress
    function loadProgress() {
      const saved = localStorage.getItem('moeflavor_training_progress');
      if (saved) {
        const data = JSON.parse(saved);
        gameState.stats = data.stats || gameState.stats;
        gameState.progress = data.progress || gameState.progress;

        // Unlock locations based on progress
        gameState.progress.completedLocations.forEach((locId, index) => {
          const nextIndex = index + 1;
          if (nextIndex < gameState.questLocations.length) {
            gameState.questLocations[nextIndex].unlocked = true;
          }
        });
      }
      updateStatsDisplay();
      if (document.getElementById('questMarkers')) {
        renderQuestMarkers();
      }
    }

    // Save progress
    function saveProgress() {
      const data = {
        stats: gameState.stats,
        progress: gameState.progress
      };
      localStorage.setItem('moeflavor_training_progress', JSON.stringify(data));
    }

    // Fetch training data from Google Sheets
    async function fetchTrainingData() {
      try {
        console.log('Fetching training data from:', SCRIPT_URL);
        const response = await fetch(SCRIPT_URL);
        console.log('Response status:', response.status);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('Training data loaded successfully:', data);
        gameState.trainingData = data;
      } catch (error) {
        console.error('Failed to load training data:', error);
        console.log('Using fallback data');
        alert('‚ö†Ô∏è Could not connect to Google Sheets. Using demo data. Please check the console for details.');

        // Use fallback data if API fails
        gameState.trainingData = {
          locations: [
            { Location_ID: 'Castle', Title: 'The Castle', Icon: 'üè∞', Description: 'Company Foundation & Culture', Status: 'active' }
          ],
          modules: [
            {
              Module_ID: 'M1',
              Location_ID: 'Castle',
              Module_Number: 1,
              Title: 'Welcome to MoeFlavor',
              Description: 'Learn about our company and culture',
              Icon: 'üìú',
              Status: 'active'
            }
          ],
          lessons: [
            {
              Lesson_ID: 'L1.1',
              Module_ID: 'M1',
              Lesson_Number: 1,
              Title: 'Welcome to MoeFlavor',
              Duration: '5 min',
              Content_Type: 'text',
              Status: 'active'
            },
            {
              Lesson_ID: 'L1.2',
              Module_ID: 'M1',
              Lesson_Number: 2,
              Title: 'Getting Started',
              Duration: '10 min',
              Content_Type: 'text',
              Status: 'active'
            }
          ],
          lessonContent: [
            {
              Lesson_ID: 'L1.1',
              Text_Content: 'Welcome to the MoeFlavor family! This is demo data.\n\nPlease configure your Google Apps Script to see real training content.\n\nMake sure your Google Sheet has these tabs:\n- LocationSheet\n- Modules\n- Lessons\n- LessonContent\n- Quizzes\n- Team\n- UserProgress',
              Video_URL: null,
              Image_URL: null,
              PDF_URL: null
            },
            {
              Lesson_ID: 'L1.2',
              Text_Content: 'This is a sample lesson showing how the training portal works.\n\nClick through the modules and lessons to explore the interface.\n\nReplace this with your actual Google Sheets data to see your real content.',
              Video_URL: null,
              Image_URL: null,
              PDF_URL: null
            }
          ],
          quizzes: [],
          team: [],
          userProgress: []
        };
      }
    }

    // Update stats display - minimal corner HUD
    function updateStatsDisplay() {
      document.getElementById('hpText').textContent = gameState.stats.hp;
      document.getElementById('xpText').textContent = `${gameState.stats.xp}/${gameState.stats.maxXp}`;
      document.getElementById('levelText').textContent = gameState.stats.level;
    }

    // Add XP
    function addXP(amount) {
      gameState.stats.xp += amount;
      if (gameState.stats.xp >= gameState.stats.maxXp) {
        gameState.stats.level++;
        gameState.stats.xp = 0;
        gameState.stats.maxXp = Math.floor(gameState.stats.maxXp * 1.5);
        gameState.stats.hp = gameState.stats.maxHp;
      }
      updateStatsDisplay();
      saveProgress();
    }

    // Render quest markers on the map
    function renderQuestMarkers() {
      const container = document.getElementById('questMarkers');
      container.innerHTML = '';

      gameState.questLocations.forEach(location => {
        const marker = document.createElement('div');
        marker.className = 'quest-marker' + (location.unlocked ? '' : ' locked');
        marker.style.left = `${location.x}%`;
        marker.style.top = `${location.y}%`;
        marker.style.transform = 'translate(-50%, -50%)';

        const icon = document.createElement('div');
        icon.className = 'quest-marker-icon';
        icon.textContent = location.icon;

        const label = document.createElement('div');
        label.className = 'quest-marker-label';
        label.textContent = location.name;

        marker.appendChild(icon);
        marker.appendChild(label);

        marker.addEventListener('click', () => {
          if (location.unlocked) {
            openQuestModal(location);
          } else {
            // Subtle locked feedback
            marker.style.animation = 'shake 0.3s';
            setTimeout(() => {
              marker.style.animation = 'bounce 2s ease-in-out infinite';
            }, 300);
          }
        });

        container.appendChild(marker);
      });
    }

    // Open quest modal - shows modules for a location
    function openQuestModal(location) {
      const modal = document.getElementById('questModal');
      const title = document.getElementById('modalTitle');
      const description = document.getElementById('modalDescription');
      const body = document.getElementById('modalBody');

      title.textContent = location.name;
      description.textContent = `Welcome to the ${location.name}! Choose a training module to begin.`;

      // Get modules for this location
      if (gameState.trainingData && gameState.trainingData.modules) {
        const locationModules = gameState.trainingData.modules.filter(
          module => module.Location_ID === location.id && module.Status === 'active'
        );

        if (locationModules.length > 0) {
          // Sort by Module_Number
          locationModules.sort((a, b) => (a.Module_Number || 0) - (b.Module_Number || 0));

          let html = '<div class="lessonList">';
          locationModules.forEach(module => {
            // Check if module is completed
            const moduleCompleted = isModuleCompleted(module.Module_ID);
            const statusClass = moduleCompleted ? 'completed' : '';

            html += `
              <div class="lessonItem ${statusClass}" onclick="viewModule('${module.Module_ID}', '${location.id}')">
                <strong>${module.Icon || 'üìö'} ${module.Title}</strong>
                <p style="font-size: 0.9em; margin-top: 5px; color: #fff;">
                  ${module.Description || 'Click to view lessons'}
                </p>
                ${moduleCompleted ? '<p style="font-size: 0.8em; color: #21ef80; margin-top: 5px;">‚úÖ Completed</p>' : ''}
              </div>
            `;
          });
          html += '</div>';
          body.innerHTML = html;
        } else {
          body.innerHTML = '<p>No training modules available for this location yet.</p>';
        }
      } else {
        body.innerHTML = '<p>Loading training data...</p>';
      }

      modal.classList.add('active');
    }

    // Check if all lessons in a module are completed
    function isModuleCompleted(moduleId) {
      if (!gameState.trainingData || !gameState.trainingData.lessons) return false;

      const moduleLessons = gameState.trainingData.lessons.filter(
        lesson => lesson.Module_ID === moduleId && lesson.Status === 'active'
      );

      if (moduleLessons.length === 0) return false;

      return moduleLessons.every(lesson =>
        gameState.progress.completedLessons[lesson.Lesson_ID]
      );
    }

    // View module - shows lessons in a module
    window.viewModule = function(moduleId, locationId) {
      const modal = document.getElementById('questModal');
      const title = document.getElementById('modalTitle');
      const description = document.getElementById('modalDescription');
      const body = document.getElementById('modalBody');

      // Find the module
      const module = gameState.trainingData.modules.find(m => m.Module_ID === moduleId);
      if (!module) {
        alert('Module not found');
        return;
      }

      title.textContent = `${module.Icon || 'üìö'} ${module.Title}`;
      description.textContent = module.Description || 'Complete the lessons below';

      // Get lessons for this module
      const moduleLessons = gameState.trainingData.lessons.filter(
        lesson => lesson.Module_ID === moduleId && lesson.Status === 'active'
      );

      if (moduleLessons.length > 0) {
        // Sort by Lesson_Number
        moduleLessons.sort((a, b) => (a.Lesson_Number || 0) - (b.Lesson_Number || 0));

        let html = '<div class="lessonList">';
        moduleLessons.forEach(lesson => {
          const completed = gameState.progress.completedLessons[lesson.Lesson_ID] || false;
          const statusClass = completed ? 'completed' : '';

          html += `
            <div class="lessonItem ${statusClass}" onclick="viewLesson('${lesson.Lesson_ID}', '${moduleId}', '${locationId}')">
              <strong>${completed ? '‚úÖ' : 'üìñ'} ${lesson.Title}</strong>
              <p style="font-size: 0.9em; margin-top: 5px; color: #fff;">
                ${lesson.Duration ? `‚è±Ô∏è ${lesson.Duration}` : ''} ${completed ? '‚Ä¢ Completed!' : '‚Ä¢ Click to start'}
              </p>
            </div>
          `;
        });
        html += '</div>';

        // Back button
        html += `
          <div class="btnGroup" style="margin-top: 20px;">
            <button class="btn secondary" onclick="openQuestModal(gameState.questLocations.find(l => l.id === '${locationId}'))">
              ‚Üê Back to ${gameState.questLocations.find(l => l.id === locationId).name}
            </button>
          </div>
        `;

        body.innerHTML = html;
      } else {
        body.innerHTML = `
          <p>No lessons available in this module yet.</p>
          <div class="btnGroup" style="margin-top: 20px;">
            <button class="btn secondary" onclick="openQuestModal(gameState.questLocations.find(l => l.id === '${locationId}'))">
              ‚Üê Back to ${gameState.questLocations.find(l => l.id === locationId).name}
            </button>
          </div>
        `;
      }
    };

    // View lesson - shows lesson content
    window.viewLesson = function(lessonId, moduleId, locationId) {
      const body = document.getElementById('modalBody');
      const title = document.getElementById('modalTitle');

      // Find the lesson
      const lesson = gameState.trainingData.lessons.find(l => l.Lesson_ID === lessonId);
      if (!lesson) {
        alert('Lesson not found');
        return;
      }

      // Get lesson content
      const content = gameState.trainingData.lessonContent.find(c => c.Lesson_ID === lessonId);

      title.textContent = lesson.Title;

      let contentHtml = '';

      if (content) {
        // Video content
        if (content.Video_URL) {
          // Extract YouTube video ID and create embed
          let videoEmbed = '';
          if (content.Video_URL.includes('youtube.com') || content.Video_URL.includes('youtu.be')) {
            const videoId = content.Video_URL.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/)?.[1];
            if (videoId) {
              videoEmbed = `
                <div style="position: relative; padding-bottom: 56.25%; height: 0; margin-bottom: 20px;">
                  <iframe
                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 8px;"
                    src="https://www.youtube.com/embed/${videoId}"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen>
                  </iframe>
                </div>
              `;
            }
          } else {
            videoEmbed = `<p><a href="${content.Video_URL}" target="_blank" style="color: #F5008B;">üé• Watch Video</a></p>`;
          }
          contentHtml += videoEmbed;
        }

        // Image content
        if (content.Image_URL) {
          contentHtml += `<img src="${content.Image_URL}" style="max-width: 100%; border-radius: 8px; margin-bottom: 15px;" alt="Lesson image">`;
        }

        // Text content
        if (content.Text_Content) {
          contentHtml += `<p style="line-height: 1.8; color: #fff; white-space: pre-wrap;">${content.Text_Content}</p>`;
        }

        // PDF download
        if (content.PDF_URL) {
          contentHtml += `<p style="margin-top: 15px;"><a href="${content.PDF_URL}" target="_blank" style="color: #F5008B;">üìÑ Download PDF</a></p>`;
        }
      } else {
        contentHtml = '<p style="color: #fff;">Lesson content coming soon...</p>';
      }

      const completed = gameState.progress.completedLessons[lessonId] || false;

      body.innerHTML = `
        <div style="background: #1a1a2e; padding: 20px; border-radius: 12px; border: 2px solid #F5008B;">
          ${contentHtml}
          <div class="btnGroup" style="margin-top: 20px;">
            ${!completed ? `<button class="btn" onclick="completeLesson('${lessonId}', '${moduleId}', '${locationId}')">Mark as Complete (+100 XP)</button>` : '<p style="color: #21ef80;">‚úÖ Completed!</p>'}
            <button class="btn secondary" onclick="viewModule('${moduleId}', '${locationId}')">‚Üê Back to Module</button>
          </div>
        </div>
      `;
    };

    // Complete lesson
    window.completeLesson = function(lessonId, moduleId, locationId) {
      if (!gameState.progress.completedLessons[lessonId]) {
        gameState.progress.completedLessons[lessonId] = true;
        addXP(100);

        // Check if all modules in this location are complete
        const location = gameState.questLocations.find(l => l.id === locationId);
        if (location && !gameState.progress.completedLocations.includes(locationId)) {
          const locationModules = gameState.trainingData.modules.filter(
            m => m.Location_ID === locationId && m.Status === 'active'
          );

          const allModulesComplete = locationModules.every(module => isModuleCompleted(module.Module_ID));

          if (allModulesComplete) {
            gameState.progress.completedLocations.push(locationId);

            // Unlock next location
            const currentIndex = gameState.questLocations.findIndex(l => l.id === locationId);
            if (currentIndex >= 0 && currentIndex < gameState.questLocations.length - 1) {
              gameState.questLocations[currentIndex + 1].unlocked = true;
              renderQuestMarkers();
            }

            alert(`üéâ ${location.name} Complete! Next location unlocked!`);
          }
        }

        saveProgress();
        // Refresh the module view
        viewModule(moduleId, locationId);
      }
    };

    // Close modal
    window.closeModal = function() {
      document.getElementById('questModal').classList.remove('active');
    };

    // Initialize game
    async function init() {
      loadProgress();
      await fetchTrainingData();
      renderQuestMarkers();
      document.getElementById('loadingScreen').classList.add('hidden');
    }

    // Start game when page loads
    window.addEventListener('load', init);

    // Add shake animation dynamically
    const style = document.createElement('style');
    style.textContent = `
      @keyframes shake {
        0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
        25% { transform: translate(-50%, -50%) rotate(-5deg); }
        75% { transform: translate(-50%, -50%) rotate(5deg); }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
